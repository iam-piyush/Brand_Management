{% extends 'base.html' %}
{% load static %}

{% block title %}Campaigns - Brand Management{% endblock %}

{% block content %}
<style>
    body {
        background-color: #f8f9fa;
    }

    .header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #DEE2E6;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 30px;
    }

    .search-container {
        display: flex;
        gap: 10px;
    }

    .campaign-count {
        font-size: 14px;
        color: #212529;
        padding: 5px 10px;
        border-radius: 5px;
        margin-left: 10px;
    }

    .table th,
    .table td {
        vertical-align: middle;
        text-align: center;
    }
</style>

<div class="container mt-4">
    <div class="header">Campaigns</div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="search-container">
            <input type="text" id="search" placeholder="Search by name or ID" class="form-control">
            <input type="date" id="start_date" class="form-control">
            <input type="date" id="end_date" class="form-control">
            <button id="filterBtn" class="btn btn-primary">Filter</button>

            <!-- Brand Dropdown -->
            <select id="brandFilter" class="form-select">
                <option value="">All Brands</option>
                {% for brand in brands %}
                <option value="{{ brand.id }}">{{ brand.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="campaign-count">Total Campaigns: <span id="campaignCount">{{ campaigns|length }}</span></div>
    </div>

    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Campaign ID</th>
                <th>Name</th>
                <th>Created At</th>
                <th>Brand</th>
                <th>Newsletter ID</th>
                <th>Subscriber Base</th>
            </tr>
        </thead>
        <tbody id="campaignTable">
            {% for campaign in campaigns %}
            <tr>
                <td>{{ campaign.campaign_id }}</td>
                <td>{{ campaign.name }}</td>
                <td>{{ campaign.created_at }}</td>
                <td>{{ campaign.brand.name }}</td>
                <td>
                    {% for newsletter in campaign.newsletters.all %}
                    <span>{{ newsletter.newsletter_id }}</span>
                    {% empty %}
                    N/A
                    {% endfor %}
                </td>
                <td>{{ campaign.subscriber_base }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center">No campaigns found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function () {
        function fetchCampaigns(query = "", startDate = "", endDate = "", brandId = "") {
            $.ajax({
                url: "{% url 'get_campaigns' %}",
                type: "GET",
                data: { query: query, start_date: startDate, end_date: endDate, brand_id: brandId },
                success: function (response) {
                    let campaignTable = $("#campaignTable");
                    campaignTable.empty();
                    $("#campaignCount").text(response.length);

                    response.forEach(campaign => {
                        let newsletterDisplay = campaign.newsletters.length > 0
                            ? campaign.newsletters.map(nl => `<span>${nl}</span>`).join('')
                            : 'N/A';

                        campaignTable.append(`
                        <tr>
                            <td>${campaign.campaign_id}</td>
                            <td>${campaign.name}</td>
                            <td>${campaign.created_at}</td>
                            <td>${campaign.brand}</td>
                            <td>${newsletterDisplay}</td>
                            <td>${campaign.subscriber_base}</td>
                        </tr>
                    `);
                    });
                }
            });
        }

        $("#search").on("keyup", function () {
            fetchCampaigns($(this).val(), $("#start_date").val(), $("#end_date").val(), $("#brandFilter").val());
        });

        $("#start_date, #end_date, #brandFilter").on("change", function () {
            fetchCampaigns($("#search").val(), $("#start_date").val(), $("#end_date").val(), $("#brandFilter").val());
        });

        fetchCampaigns();
    });
</script>

{% endblock %}